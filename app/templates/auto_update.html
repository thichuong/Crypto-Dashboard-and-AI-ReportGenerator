<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Update - Crypto Report Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('üîê Phi√™n truy c·∫≠p an to√†n ƒë∆∞·ª£c kh·ªüi t·∫°o', 'info');
            addLogEntry('Kh·ªüi t·∫°o trang Auto Update System', 'info');
            refreshStatus();
            
            // Auto refresh status every 30 seconds
            setInterval(refreshStatus, 30000);
            
            // Security reminder
            setTimeout(() => {
                addLogEntry('‚ö†Ô∏è Nh·∫Øc nh·ªü: Kh√¥ng chia s·∫ª URL n√†y v·ªõi ng∆∞·ªùi kh√°c', 'info');
            }, 5000);
        });
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auto_upload.css') }}">
</head>
<body class="antialiased min-h-screen" style="background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);">

    <!-- Process Notification Overlay -->
    <div id="process-overlay" class="loading-overlay" style="display: none;">
        <div class="success-content" style="max-width: 700px;">
            <div class="text-center mb-6">
                <i class="fas fa-chart-line text-6xl text-blue-500 mb-4"></i>
                <h3 class="text-xl font-bold mb-2" style="color: var(--text-primary);">ƒêang T·∫°o B√°o C√°o Crypto</h3>
                <p class="text-sm" style="color: var(--text-secondary);">H·ªá th·ªëng ƒëang thu th·∫≠p v√† ph√¢n t√≠ch d·ªØ li·ªáu th·ªã tr∆∞·ªùng</p>
            </div>
            
            <!-- Progress Table -->
            <div class="bg-white rounded-lg border shadow-sm">
                <div class="px-4 py-3 border-b bg-gray-50 rounded-t-lg">
                    <h4 class="text-sm font-semibold text-gray-800">
                        <i class="fas fa-tasks mr-2"></i>Ti·∫øn ƒê·ªô Th·ª±c Hi·ªán
                    </h4>
                </div>
                <div class="max-h-80 overflow-y-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left text-gray-700 font-medium w-12">B∆∞·ªõc</th>
                                <th class="px-4 py-2 text-left text-gray-700 font-medium">T√™n C√¥ng Vi·ªác</th>
                                <th class="px-4 py-2 text-left text-gray-700 font-medium">Chi Ti·∫øt</th>
                                <th class="px-4 py-2 text-left text-gray-700 font-medium w-20">Tr·∫°ng Th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="progress-table-body" class="divide-y divide-gray-200">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-6">
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="bg-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm mt-2" style="color: var(--text-secondary);">
                    <span>Ti·∫øn ƒë·ªô t·ªïng th·ªÉ</span>
                    <span id="progress-text">0%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div id="success-overlay" class="loading-overlay" style="display: none;">
        <div class="success-content">
            <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
            <p id="success-message" class="text-lg font-semibold mb-4">B√°o c√°o ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!</p>
            <button onclick="closeSuccessOverlay()" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-check mr-2"></i>ƒê√≥ng
            </button>
        </div>
    </div>

    <!-- Error Overlay -->
    <div id="error-overlay" class="loading-overlay" style="display: none;">
        <div class="error-content">
            <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
            <p id="error-message" class="text-lg font-semibold mb-4">ƒê√£ x·∫£y ra l·ªói!</p>
            <button onclick="closeErrorOverlay()" class="px-6 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                <i class="fas fa-times mr-2"></i>ƒê√≥ng
            </button>
        </div>
    </div>

    {% include 'components/theme_toggle.html' %}

    <div class="auto-update-container">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2" style="color: var(--text-primary);">
                <i class="fas fa-shield-alt mr-3" style="color: var(--accent-color);"></i>
                Auto Update System
            </h1>
            <p style="color: var(--text-secondary);" class="text-lg">
                H·ªá th·ªëng t·ª± ƒë·ªông t·∫°o b√°o c√°o nghi√™n c·ª©u th·ªã tr∆∞·ªùng crypto
            </p>
            <div class="mt-3 inline-flex items-center px-3 py-1 rounded-full text-sm" style="background-color: rgba(34, 197, 94, 0.1); color: var(--positive-color);">
                <i class="fas fa-lock mr-2"></i>
                Phi√™n truy c·∫≠p an to√†n
            </div>
        </div>

        <!-- Status Card -->
        <div class="status-card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold" style="color: var(--text-primary);">
                    <i class="fas fa-info-circle mr-2" style="color: var(--accent-color);"></i>
                    Tr·∫°ng Th√°i H·ªá Th·ªëng
                </h2>
                <button onclick="refreshStatus()" class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                    <i class="fas fa-sync-alt mr-1"></i>L√†m m·ªõi
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-sm font-medium mb-2" style="color: var(--text-secondary);">Scheduler Status:</p>
                    <div id="scheduler-status" class="status-indicator status-inactive">
                        <i class="fas fa-circle mr-2"></i>ƒêang t·∫£i...
                    </div>
                </div>
                <div>
                    <p class="text-sm font-medium mb-2" style="color: var(--text-secondary);">Kho·∫£ng th·ªùi gian:</p>
                    <span id="interval-info" class="text-sm font-mono" style="color: var(--text-primary);">--</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div class="p-3 rounded-lg" style="background: var(--bg-secondary);">
                    <p class="text-sm font-medium mb-1" style="color: var(--text-secondary);">API Key Status:</p>
                    <span id="api-key-status" class="text-sm font-mono" style="color: var(--text-primary);">ƒêang ki·ªÉm tra...</span>
                </div>
                <div class="p-3 rounded-lg" style="background: var(--bg-secondary);">
                    <p class="text-sm font-medium mb-1" style="color: var(--text-secondary);">T·ªïng b√°o c√°o:</p>
                    <span id="total-reports" class="text-sm font-mono" style="color: var(--text-primary);">--</span>
                </div>
            </div>
            
            <div class="mt-4 p-3 rounded-lg" style="background: var(--bg-secondary);">
                <p class="text-sm font-medium mb-1" style="color: var(--text-secondary);">B√°o c√°o cu·ªëi c√πng:</p>
                <span id="latest-report-time" class="text-sm font-mono" style="color: var(--text-primary);">Ch∆∞a c√≥ b√°o c√°o</span>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="status-card">
            <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">
                <i class="fas fa-cogs mr-2" style="color: var(--accent-color);"></i>
                ƒêi·ªÅu Khi·ªÉn
            </h2>
            
            <div class="control-panel">
                <button id="trigger-report-btn" onclick="triggerManualReport()" 
                        class="flex items-center justify-center px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-medium hover:from-green-600 hover:to-green-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <i class="fas fa-play mr-2"></i>
                    T·∫°o B√°o C√°o Ngay
                </button>
                
                <button onclick="viewLatestReport()" 
                        class="flex items-center justify-center px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-medium hover:from-blue-600 hover:to-blue-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <i class="fas fa-eye mr-2"></i>
                    Xem B√°o C√°o M·ªõi Nh·∫•t
                </button>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="status-card">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold" style="color: var(--text-primary);">
                    <i class="fas fa-list-alt mr-2" style="color: var(--accent-color);"></i>
                    Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông
                </h2>
                <button onclick="clearLog()" class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                    <i class="fas fa-trash mr-1"></i>X√≥a log
                </button>
            </div>
            
            <div id="activity-log" class="log-container">
                <div class="log-entry log-info">
                    <span class="log-timestamp">[H·ªá th·ªëng]</span> ƒêang t·∫£i th√¥ng tin...
                </div>
            </div>
        </div>

        <!-- Configuration Info -->
        <div class="status-card">
            <h2 class="text-xl font-bold mb-4" style="color: var(--text-primary);">
                <i class="fas fa-info-circle mr-2" style="color: var(--accent-color);"></i>
                Th√¥ng Tin C·∫•u H√¨nh
            </h2>
            
            <div class="text-sm space-y-2" style="color: var(--text-secondary);">
                <p><strong>B·∫£o m·∫≠t:</strong> Trang n√†y y√™u c·∫ßu secret key ƒë·ªÉ truy c·∫≠p</p>
                <p><strong>URL format:</strong> /auto-update-system-&lt;secret_key&gt;</p>
                <p><strong>T√≠nh nƒÉng:</strong> T·∫°o b√°o c√°o nghi√™n c·ª©u th·ªã tr∆∞·ªùng crypto t·ª± ƒë·ªông</p>
                <p><strong>D·ªØ li·ªáu:</strong> L·∫•y t·ª´ TradingView, CoinMarketCap v√† c√°c ngu·ªìn uy t√≠n</p>
                <p><strong>AI Model:</strong> Google Gemini 2.5 Pro</p>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/theme-manager.js') }}" defer></script>
    <script>
        // Global variables
        let logEntries = [];
        let socket = null;
        let currentSessionId = null;
        
        // Initialize SocketIO
        function initializeSocket() {
            console.log('[SOCKETIO] Initializing socket connection...');
            socket = io();
            
            socket.on('connect', function() {
                console.log('[SOCKETIO] Connected to server');
                addLogEntry('üîó K·∫øt n·ªëi server th√†nh c√¥ng', 'info');
            });
            
            socket.on('disconnect', function() {
                console.log('[SOCKETIO] Disconnected from server');
                addLogEntry('‚ö†Ô∏è M·∫•t k·∫øt n·ªëi server', 'info');
            });
            
            socket.on('progress_update', function(data) {
                console.log('[SOCKETIO] Received progress update:', data);
                updateProgressFromServer(data);
            });
            
            socket.on('connect_error', function(error) {
                console.error('[SOCKETIO] Connection error:', error);
                addLogEntry('‚ùå L·ªói k·∫øt n·ªëi SocketIO: ' + error, 'error');
            });
        }
        
        // Update progress from server
        function updateProgressFromServer(data) {
            console.log('[PROGRESS] Received update for session:', data.session_id, 'current session:', currentSessionId);
            if (data.session_id !== currentSessionId) return;
            
            const progress = data.progress;
            console.log('[PROGRESS] Processing progress update:', progress);
            
            // Update progress bar
            updateProgressBar(progress.percentage);
            
            // Update current step
            updateStepProgress(progress.step, progress.current_step_name, progress.details);
            
            // Update log if details available
            if (progress.details) {
                addLogEntry(progress.details, 'info');
            }
            
            // Handle completion
            if (progress.status === 'completed') {
                console.log('[PROGRESS] Workflow completed!');
                setTimeout(() => {
                    hideProcessNotification();
                    document.getElementById('success-message').textContent = 
                        `B√°o c√°o #${progress.report_id} ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!`;
                    document.getElementById('success-overlay').style.display = 'flex';
                    
                    // Restore button
                    const btn = document.getElementById('trigger-report-btn');
                    btn.innerHTML = '<i class="fas fa-play mr-2"></i>T·∫°o B√°o C√°o Ngay';
                    btn.disabled = false;
                    
                    addLogEntry('üéâ Ho√†n th√†nh t·∫°o b√°o c√°o!', 'success');
                }, 1000);
            } else if (progress.status === 'error') {
                console.log('[PROGRESS] Workflow error:', progress.details);
                setTimeout(() => {
                    hideProcessNotification();
                    document.getElementById('error-message').textContent = 
                        progress.details || 'C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh t·∫°o b√°o c√°o';
                    document.getElementById('error-overlay').style.display = 'flex';
                    
                    // Restore button
                    const btn = document.getElementById('trigger-report-btn');
                    btn.innerHTML = '<i class="fas fa-play mr-2"></i>T·∫°o B√°o C√°o Ngay';
                    btn.disabled = false;
                    
                    addLogEntry('üí• C√≥ l·ªói x·∫£y ra!', 'error');
                }, 1000);
            }
        }
        
        // Show process notification
        function showProcessNotification() {
            document.getElementById('process-overlay').style.display = 'flex';
            resetProcessSteps();
        }
        
        // Hide process notification
        function hideProcessNotification() {
            document.getElementById('process-overlay').style.display = 'none';
            if (currentSessionId && socket) {
                socket.emit('leave_progress', { session_id: currentSessionId });
                currentSessionId = null;
            }
        }
        
        // Reset process steps
        function resetProcessSteps() {
            const tableBody = document.getElementById('progress-table-body');
            tableBody.innerHTML = '';
            
            // Initialize table with all steps
            const steps = [
                'Chu·∫©n b·ªã d·ªØ li·ªáu v√† kh·ªüi t·∫°o AI',
                'Thu th·∫≠p d·ªØ li·ªáu t·ª´ internet',
                'Ki·ªÉm tra ch·∫•t l∆∞·ª£ng b√°o c√°o',
                'T·∫°o giao di·ªán b√°o c√°o', 
                'Tr√≠ch xu·∫•t m√£ ngu·ªìn',
                'L∆∞u b√°o c√°o v√†o database',
                'Ho√†n th√†nh'
            ];
            
            steps.forEach((stepName, index) => {
                const row = document.createElement('tr');
                row.id = `progress-row-${index + 1}`;
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 text-gray-700 font-mono">${index + 1}</td>
                    <td class="px-4 py-2 text-gray-800">${stepName}</td>
                    <td class="px-4 py-2 text-gray-600 text-sm">ƒêang ch·ªù...</td>
                    <td class="px-4 py-2">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                            <i class="fas fa-clock mr-1"></i>Ch·ªù
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            updateProgressBar(0);
        }
        
        // Update step progress
        function updateStepProgress(stepNumber, stepName, details) {
            // Complete previous steps
            for (let i = 1; i < stepNumber; i++) {
                const row = document.getElementById(`progress-row-${i}`);
                if (row) {
                    const statusCell = row.cells[3];
                    statusCell.innerHTML = `
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check mr-1"></i>Ho√†n th√†nh
                        </span>
                    `;
                    row.className = 'bg-green-50 hover:bg-green-100';
                }
            }
            
            // Update current step
            const currentRow = document.getElementById(`progress-row-${stepNumber}`);
            if (currentRow) {
                currentRow.className = 'bg-blue-50 hover:bg-blue-100';
                
                // Update step name if provided
                if (stepName) {
                    currentRow.cells[1].textContent = stepName;
                }
                
                // Update details if provided
                if (details) {
                    currentRow.cells[2].textContent = details;
                }
                
                // Update status
                const statusCell = currentRow.cells[3];
                statusCell.innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i class="fas fa-spinner fa-spin mr-1"></i>ƒêang th·ª±c hi·ªán
                    </span>
                `;
            }
        }
        
        // Update progress bar
        function updateProgressBar(percentage) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar && progressText) {
                progressBar.style.width = percentage + '%';
                progressText.textContent = Math.round(percentage) + '%';
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            addLogEntry('üîê Phi√™n truy c·∫≠p an to√†n ƒë∆∞·ª£c kh·ªüi t·∫°o', 'info');
            addLogEntry('Kh·ªüi t·∫°o trang Auto Update System', 'info');
            refreshStatus();
            
            // Auto refresh status every 30 seconds
            setInterval(refreshStatus, 30000);
            
            // Security reminder
            setTimeout(() => {
                addLogEntry('‚ö†Ô∏è Nh·∫Øc nh·ªü: Kh√¥ng chia s·∫ª URL n√†y v·ªõi ng∆∞·ªùi kh√°c', 'info');
            }, 5000);
        });
        
        // Add log entry
        function addLogEntry(message, type = 'info') {
            const timestamp = new Date().toLocaleString('vi-VN');
            const entry = {
                timestamp: timestamp,
                message: message,
                type: type
            };
            
            logEntries.unshift(entry);
            
            // Keep only last 50 entries
            if (logEntries.length > 50) {
                logEntries = logEntries.slice(0, 50);
            }
            
            updateLogDisplay();
        }
        
        // Update log display
        function updateLogDisplay() {
            const logContainer = document.getElementById('activity-log');
            logContainer.innerHTML = '';
            
            logEntries.forEach(entry => {
                const logDiv = document.createElement('div');
                logDiv.className = `log-entry log-${entry.type}`;
                logDiv.innerHTML = `<span class="log-timestamp">[${entry.timestamp}]</span> ${entry.message}`;
                logContainer.appendChild(logDiv);
            });
        }
        
        // Clear log
        function clearLog() {
            logEntries = [];
            updateLogDisplay();
            addLogEntry('ƒê√£ x√≥a nh·∫≠t k√Ω ho·∫°t ƒë·ªông', 'info');
        }
        
        // Refresh status
        async function refreshStatus() {
            try {
                const response = await fetch('/scheduler-status');
                const data = await response.json();
                
                const statusElement = document.getElementById('scheduler-status');
                const intervalElement = document.getElementById('interval-info');
                const apiKeyElement = document.getElementById('api-key-status');
                
                // Update scheduler status
                if (data.status === 'active') {
                    statusElement.className = 'status-indicator status-active';
                    statusElement.innerHTML = '<i class="fas fa-circle mr-2"></i>ƒêang ho·∫°t ƒë·ªông';
                } else {
                    statusElement.className = 'status-indicator status-inactive';
                    statusElement.innerHTML = '<i class="fas fa-circle mr-2"></i>Kh√¥ng ho·∫°t ƒë·ªông';
                }
                
                // Update interval
                intervalElement.textContent = `${data.interval_hours} gi·ªù`;
                
                // Update API key status
                apiKeyElement.textContent = data.has_api_key ? 'ƒê√£ c·∫•u h√¨nh' : 'Ch∆∞a c·∫•u h√¨nh';
                apiKeyElement.style.color = data.has_api_key ? 'var(--positive-color)' : 'var(--negative-color)';
                
                // Update total reports
                document.getElementById('total-reports').textContent = data.total_reports || 0;
                
                // Update latest report time
                const latestTimeElement = document.getElementById('latest-report-time');
                if (data.latest_report_time) {
                    const date = new Date(data.latest_report_time);
                    latestTimeElement.textContent = date.toLocaleString('vi-VN');
                } else {
                    latestTimeElement.textContent = 'Ch∆∞a c√≥ b√°o c√°o';
                }
                
                addLogEntry(`C·∫≠p nh·∫≠t tr·∫°ng th√°i: ${data.status}`, 'info');
                
            } catch (error) {
                addLogEntry(`L·ªói khi t·∫£i tr·∫°ng th√°i: ${error.message}`, 'error');
            }
        }
        
        // Trigger manual report with SocketIO progress tracking
        async function triggerManualReport() {
            // Confirmation dialog
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·∫°o b√°o c√°o m·ªõi? Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.')) {
                return;
            }
            
            const btn = document.getElementById('trigger-report-btn');
            const originalContent = btn.innerHTML;
            
            // Show loading state
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ƒêang kh·ªüi t·∫°o...';
            btn.disabled = true;
            
            // Show process notification
            showProcessNotification();
            addLogEntry('üöÄ B·∫Øt ƒë·∫ßu t·∫°o b√°o c√°o t·ª± ƒë·ªông v·ªõi real-time tracking', 'info');
            
            try {
                const response = await fetch('/generate-auto-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Set session ID and join room for progress updates
                    currentSessionId = data.session_id;
                    console.log('[WORKFLOW] Started with session ID:', currentSessionId);
                    if (socket) {
                        console.log('[SOCKETIO] Joining progress room:', currentSessionId);
                        socket.emit('join_progress', { session_id: currentSessionId });
                        addLogEntry(`üì° ƒê√£ k·∫øt n·ªëi progress tracking: ${currentSessionId}`, 'info');
                    } else {
                        console.error('[SOCKETIO] Socket not available!');
                        addLogEntry('‚ö†Ô∏è C·∫£nh b√°o: Socket kh√¥ng kh·∫£ d·ª•ng', 'error');
                    }
                    
                    // Update button to show it's running
                    btn.innerHTML = '<i class="fas fa-cog fa-spin mr-2"></i>ƒêang ch·∫°y...';
                    addLogEntry('‚úÖ Workflow ƒë√£ ƒë∆∞·ª£c kh·ªüi ch·∫°y th√†nh c√¥ng', 'success');
                } else {
                    hideProcessNotification();
                    document.getElementById('error-message').textContent = data.message;
                    document.getElementById('error-overlay').style.display = 'flex';
                    addLogEntry(`‚ùå L·ªói t·∫°o b√°o c√°o: ${data.message}`, 'error');
                    
                    // Restore button
                    btn.innerHTML = originalContent;
                    btn.disabled = false;
                }
                
            } catch (error) {
                hideProcessNotification();
                document.getElementById('error-message').textContent = `L·ªói k·∫øt n·ªëi: ${error.message}`;
                document.getElementById('error-overlay').style.display = 'flex';
                addLogEntry(`üîå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
                
                // Restore button
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }
        
        // View latest report
        function viewLatestReport() {
            addLogEntry('üìÑ Chuy·ªÉn ƒë·∫øn trang ch·ªß ƒë·ªÉ xem b√°o c√°o m·ªõi nh·∫•t', 'info');
            window.open('/', '_blank');
        }
        
        // Close overlays
        function closeSuccessOverlay() {
            document.getElementById('success-overlay').style.display = 'none';
            refreshStatus(); // Refresh to show new report count
        }
        
        function closeErrorOverlay() {
            document.getElementById('error-overlay').style.display = 'none';
        }
    </script>
</body>
</html>
