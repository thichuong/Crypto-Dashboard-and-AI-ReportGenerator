<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if report %}Báo cáo #{{ report.id }} - {% endif %}Dashboard Toàn Cảnh Thị Trường</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/colors.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chart.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/report.css') }}">
    {% if report and report.css_content %}
        <style>
            /* <![CDATA[ */
            {{ report.css_content | safe }}
            /* ]]> */
        </style>
    {% endif %}
</head>
<body class="antialiased">

    {% include 'components/theme_toggle.html' %}
    {% include 'components/language_toggle.html' %}

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-green-500"><span data-i18n="site-title">Toàn Cảnh Thị Trường Tiền Mã Hóa</span></h1>
            {% if report %}
                <p class="text-lg text-gray-600 max-w-3xl mx-auto">
                    <span data-i18n="report-display">Hiển thị báo cáo</span> (<span data-i18n="created-at">tạo lúc</span> {{ report.created_at.strftime('%d-%m-%Y %H:%M') }} UTC)
                </p>
            {% else %}
                <p class="text-lg text-gray-600 max-w-3xl mx-auto" data-i18n="analysis-summary">Bài phân tích và tổng hợp</p>
            {% endif %}

            <div class="mt-6 flex justify-center items-center space-x-4">
                <!-- <a href="{{ url_for('upload_page') }}" class="inline-block bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300">
                    <i class="fas fa-upload mr-2"></i> <span data-i18n="create-report">Tạo Báo cáo Mới</span>
                </a> -->
                <a href="{{ url_for('report_list') }}" class="inline-block bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-800 transition-colors duration-300">
                    <i class="fas fa-history mr-2"></i> <span data-i18n="view-report-history">Xem Lịch Sử Báo Cáo</span>
                </a>
                {% if report %}
                <a href="{{ url_for('pdf_template', report_id=report.id) }}" target="_blank" class="inline-block bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-300">
                    <i class="fas fa-print mr-2"></i> <span data-i18n="print-report">In Báo cáo</span>
                </a>
                {% endif %}
            </div>
        </header>



        <div class="space-y-6 mb-12">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="card">
                    <div class="flex items-center mb-2">
                        <i class="fab fa-bitcoin text-yellow-500 text-3xl mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-700">Giá BTC</h3>
                    </div>
                    <div id="btc-price-container">
                        <div class="skeleton h-9 w-3/4 mb-2"></div>
                        <div class="skeleton h-5 w-1/2"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-globe-americas text-blue-500 text-3xl mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-700">Tổng Vốn Hóa</h3>
                    </div>
                    <div id="market-cap-container">
                        <div class="skeleton h-9 w-3/4 mb-2"></div>
                        <div class="skeleton h-5 w-1/2"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-chart-line text-green-500 text-3xl mr-3"></i>
                        <h3 class="text-lg font-semibold text-gray-700">Khối Lượng Giao Dịch 24h</h3>
                    </div>
                     <div id="volume-24h-container">
                        <div class="skeleton h-9 w-3/4 mb-2"></div>
                        <div class="skeleton h-5 w-1/2"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Chỉ số Sợ hãi & Tham lam</h3>
                    <div id="fear-greed-container" class="w-full max-w-sm mx-auto">
                        <div class="skeleton h-48 w-full rounded-full"></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Chỉ số Sức mạnh Tương đối (RSI 14) - BTC</h3>
                    <div id="rsi-container" class="w-full max-w-sm mx-auto">
                        <div class="skeleton h-48 w-full rounded-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tuyên bố miễn trừ trách nhiệm: chỉ mang tính chất tham khảo (i18n) -->
    <div id="disclaimer" class="mb-6">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                <p class="text-sm text-gray-700">
                    <strong data-i18n="disclaimer-title">Tuyên bố miễn trừ trách nhiệm:</strong>
                    <span data-i18n="disclaimer-body">Nội dung và phân tích trên trang này chỉ mang tính chất tham khảo và không cấu thành lời khuyên đầu tư. Mọi quyết định đầu tư là trách nhiệm của người đọc.</span>
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-x-12 pb-96">
            <aside class="hidden lg:block lg:col-span-1">
                 <nav id="report-navigation-panel" class="sticky top-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 tracking-wide">Mục lục Báo cáo</h3>
                    <ul id="report-nav-links" class="space-y-2">
                        </ul>
                </nav>
            </aside>

            <main id="report-container" class="lg:col-span-3" {% if report %}data-report-id="{{ report.id }}"{% endif %}>
                    {% if report and report.html_content %}
                        <div id="report-content-vi" style="display: block;">
                            {{ report.html_content | safe }}
                        </div>
                        {% if report.html_content_en %}
                            <div id="report-content-en" style="display: none;">
                                {{ report.html_content_en | safe }}
                            </div>
                        {% endif %}

                    {% else %}
                        <div class="placeholder">
                            <h2>Chưa có báo cáo nào được tạo.</h2>
                            <p>Vui lòng sử dụng trang <a href="{{ url_for('upload_page') }}">tải lên</a> để tạo báo cáo đầu tiên của bạn.</p>
                        </div>
                    {% endif %}
            </main>
        </div>
    </div>
    
    <!-- Chart modules được tải trực tiếp với auto-discovery -->
    <script>
        {{ get_chart_modules_content() | safe }}
    </script>
    
    {% if report and report.js_content %}
        <!-- Single JS content that supports both VI and EN languages natively -->
        <script id="report-js">
            {{ report.js_content | safe }}
        </script>
    {% endif %}
    
    <script src="{{ url_for('static', filename='js/theme-manager.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/language-toggle.js') }}" defer></script>

    <script>
        // Inline fallback language toggle (keeps UI responsive if external file missing)
        (function () {
            const STORAGE_KEY = 'app_lang';
            function getLang() { return localStorage.getItem(STORAGE_KEY) || 'vi'; }
            function setLang(lang) { localStorage.setItem(STORAGE_KEY, lang); applyLang(lang); }
            function applyLang(lang) {
                const en = document.getElementById('report-content-en');
                const vi = document.getElementById('report-content-vi');
                if (en) en.style.display = (lang === 'en') ? 'block' : 'none';
                if (vi) vi.style.display = (lang === 'vi') ? 'block' : 'none';
                // Toggle any elements with data-i18n attribute by showing/hiding english variants if present
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    // if element has children spans for languages, toggle them
                    const enChild = el.querySelector('.i18n-en');
                    const viChild = el.querySelector('.i18n-vi');
                    if (enChild || viChild) {
                        if (enChild) enChild.style.display = (lang === 'en') ? 'inline' : 'none';
                        if (viChild) viChild.style.display = (lang === 'vi') ? 'inline' : 'none';
                    }
                });
            }

            // Wire language toggle buttons (assumes components/language_toggle.html creates .lang-btn elements)
            document.addEventListener('click', function (e) {
                const btn = e.target.closest && e.target.closest('.lang-btn');
                if (!btn) return;
                const lang = btn.getAttribute('data-lang');
                if (lang) setLang(lang);
            });

            // Apply language on load
            document.addEventListener('DOMContentLoaded', function () { applyLang(getLang()); });
            window.applyAppLanguage = applyLang; // for debugging
        })();
    </script>
</body>
</html>