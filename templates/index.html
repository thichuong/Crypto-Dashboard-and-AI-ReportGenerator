<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phân Tích Thị Trường Crypto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-green-500">Toàn Cảnh Thị Trường Tiền Mã Hóa</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">Phân tích Kỷ nguyên Vốn hóa 4 Nghìn Tỷ USD và Sự Dịch chuyển Dòng vốn Chiến lược</p>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="card">
                <div class="flex items-center mb-2">
                    <i class="fab fa-bitcoin text-yellow-500 text-3xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">Giá BTC</h3>
                </div>
                <p id="btc-price" class="text-3xl font-bold text-gray-900">Loading...</p>
                <p id="btc-change" class="text-sm">Loading...</p>
            </div>
            <div class="card">
                <div class="flex items-center mb-2">
                    <i class="fas fa-globe-americas text-blue-500 text-3xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">Tổng Vốn Hóa</h3>
                </div>
                <p id="market-cap" class="text-3xl font-bold text-gray-900">Loading...</p>
                 <p class="text-sm text-gray-500">Toàn thị trường</p>
            </div>
            <div class="card">
                <div class="flex items-center mb-2">
                    <i class="fas fa-chart-line text-green-500 text-3xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">Khối Lượng Giao Dịch 24h</h3>
                </div>
                <p id="volume-24h" class="text-3xl font-bold text-gray-900">Loading...</p>
                 <p class="text-sm text-gray-500">Toàn thị trường</p>
            </div>
            <div class="card">
                <div class="flex items-center mb-2">
                    <i class="fas fa-gauge-high text-red-500 text-3xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">Sợ hãi & Tham lam</h3>
                </div>
                <p id="fear-greed-value" class="text-3xl font-bold text-gray-900">Loading...</p>
                <p id="fear-greed-text" class="text-sm font-medium">Loading...</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-x-12">
            <aside class="hidden lg:block lg:col-span-1">
                 <nav id="report-navigation-panel" class="sticky top-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3 tracking-wide">Mục lục Báo cáo</h3>
                    <ul id="report-nav-links" class="space-y-2">
                        </ul>
                </nav>
            </aside>

            <main id="report-container" class="lg:col-span-3">
                 </main>
        </div>
    </div>

    <script>
        function formatNumber(num) {
            if (!num) return 'N/A';
            if (num >= 1e12) return (num / 1e12).toFixed(2) + ' nghìn tỷ';
            if (num >= 1e9) return (num / 1e9).toFixed(2) + ' tỷ';
            if (num >= 1e6) return (num / 1e6).toFixed(2) + ' triệu';
            return num.toLocaleString('en-US');
        }

        async function fetchCryptoData() {
            try {
                const response = await fetch('/api/crypto/global');
                if (!response.ok) throw new Error('Error fetching global data.');
                const data = await response.json();
                document.getElementById('market-cap').textContent = '$' + formatNumber(data['market-cap']);
                document.getElementById('volume-24h').textContent = '$' + formatNumber(data['volume-24h']);
            } catch (error) {
                console.error('fetchCryptoData Error:', error);
                ['market-cap', 'volume-24h'].forEach(id => document.getElementById(id).textContent = 'Error');
            }
        }

        async function fetchBtcAndFearGreed() {
            try {
                const response = await fetch('/api/crypto/btc-and-fng');
                if (!response.ok) throw new Error('Error fetching BTC and F&G data.');
                const data = await response.json();
                const bitcoin = data.bitcoin.bitcoin;
                document.getElementById('btc-price').textContent = '$' + bitcoin.usd.toLocaleString('en-US');
                const btcChangeEl = document.getElementById('btc-change');
                const change = bitcoin.usd_24h_change;
                btcChangeEl.textContent = `${change.toFixed(2)}% (24h)`;
                btcChangeEl.className = `text-sm font-semibold ${change >= 0 ? 'text-green-600' : 'text-red-600'}`;
                const fearGreed = data.fear_and_greed.data[0];
                const valueEl = document.getElementById('fear-greed-value');
                const textEl = document.getElementById('fear-greed-text');
                valueEl.textContent = fearGreed.value;
                textEl.textContent = fearGreed.value_classification;
                let colorClass = 'text-yellow-500';
                if (parseInt(fearGreed.value) <= 25) colorClass = 'text-red-600';
                if (parseInt(fearGreed.value) >= 75) colorClass = 'text-green-600';
                textEl.className = `text-sm font-medium ${colorClass}`;
            } catch (error) {
                console.error('fetchBtcAndFearGreed Error:', error);
                ['btc-price', 'fear-greed-value'].forEach(id => document.getElementById(id).textContent = 'Error');
            }
        }

        async function loadReportAndCreateNav() {
            try {
                const response = await fetch("{{ url_for('static', filename='report.html') }}");
                if (!response.ok) throw new Error('Could not load the report file.');
                const reportHtml = await response.text();

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = reportHtml;

                const navLinksContainer = document.getElementById('report-nav-links');
                const reportContainer = document.getElementById('report-container');
                reportContainer.innerHTML = ''; // Clear previous content

                const sections = tempDiv.querySelectorAll('section');

                sections.forEach(section => {
                    const h2 = section.querySelector('h2');
                    if (h2 && section.id) {
                        reportContainer.appendChild(section);
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = `#${section.id}`;
                        const h2Text = h2.cloneNode(true);
                        h2Text.querySelector('.icon')?.remove();
                        a.textContent = h2Text.textContent.trim();
                        
                        // *** FIX STARTS HERE ***
                        // Add click event handler for instant active state
                        a.addEventListener('click', (e) => {
                            e.preventDefault();
                            
                            // Remove active class from all nav links
                            navLinksContainer.querySelectorAll('a').forEach(link => link.classList.remove('active'));
                            
                            // Add active class to the clicked link
                            e.target.classList.add('active');
                            
                            // Scroll to the section
                            document.getElementById(section.id).scrollIntoView({
                                behavior: 'smooth'
                            });
                        });
                        // *** FIX ENDS HERE ***

                        li.appendChild(a);
                        navLinksContainer.appendChild(li);
                    }
                });

                // Scroll Spy Logic (still useful for manual scrolling)
                const reportSections = reportContainer.querySelectorAll('section');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            navLinksContainer.querySelectorAll('a').forEach(link => {
                                link.classList.remove('active');
                                if (link.getAttribute('href').substring(1) === entry.target.id) {
                                    link.classList.add('active');
                                }
                            });
                        }
                    });
                }, { rootMargin: "-30% 0px -70% 0px" });

                reportSections.forEach(section => {
                    observer.observe(section);
                });

            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('report-container').innerHTML = '<p class="text-red-600 font-semibold">Error: Could not load the detailed report content.</p>';
            }
        }

        function init() {
            loadReportAndCreateNav();
            fetchCryptoData();
            fetchBtcAndFearGreed();
            setInterval(fetchCryptoData, 300000);
            setInterval(fetchBtcAndFearGreed, 300000);
        }

        window.onload = init;
    </script>
</body>
</html>