<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phân Tích Thị Trường Crypto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-green-500">Toàn Cảnh Thị Trường Tiền Mã Hóa</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">Phân tích Kỷ nguyên Vốn hóa 4 Nghìn Tỷ USD và Sự Dịch chuyển Dòng vốn Chiến lược</p>
        </header>

        <!-- Real-time Data Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <!-- Giá BTC -->
            <div class="card">
                <div class="flex items-center mb-2">
                    <i class="fab fa-bitcoin text-yellow-500 text-3xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">Giá BTC</h3>
                </div>
                <p id="btc-price" class="text-3xl font-bold text-gray-900">Loading...</p>
                <p id="btc-change" class="text-sm">Loading...</p>
            </div>
            <!-- Tổng Vốn Hóa -->
            <div class="card">
                <div class="flex items-center mb-2">
                    <i class="fas fa-globe-americas text-blue-500 text-3xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">Tổng Vốn Hóa</h3>
                </div>
                <p id="market-cap" class="text-3xl font-bold text-gray-900">Loading...</p>
                 <p class="text-sm text-gray-500">Toàn thị trường</p>
            </div>
            <!-- Khối Lượng 24h -->
            <div class="card">
                <div class="flex items-center mb-2">
                    <i class="fas fa-chart-line text-green-500 text-3xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">Khối Lượng Giao Dịch 24h</h3>
                </div>
                <p id="volume-24h" class="text-3xl font-bold text-gray-900">Loading...</p>
                 <p class="text-sm text-gray-500">Toàn thị trường</p>
            </div>
            <!-- Chỉ Số Sợ hãi & Tham lam -->
            <div class="card">
                <div class="flex items-center mb-2">
                    <i class="fas fa-gauge-high text-red-500 text-3xl mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-700">Sợ hãi & Tham lam</h3>
                </div>
                <p id="fear-greed-value" class="text-3xl font-bold text-gray-900">Loading...</p>
                <p id="fear-greed-text" class="text-sm font-medium">Loading...</p>
            </div>
        </div>


        <main id="report-container" class="bg-white p-6 md:p-8 rounded-lg border border-gray-200 shadow-lg">
            </main>
    </div>

    <script>
        // ... (hàm formatNumber giữ nguyên) ...
        function formatNumber(num) {
            if (!num) return 'N/A'; // Trả về 'N/A' nếu không có số
            if (num >= 1e12) {
                return (num / 1e12).toFixed(2) + ' nghìn tỷ';
            }
            if (num >= 1e9) {
                return (num / 1e9).toFixed(2) + ' tỷ';
            }
            if (num >= 1e6) {
                return (num / 1e6).toFixed(2) + ' triệu';
            }
            // Trả về số được định dạng với dấu phẩy ngăn cách hàng nghìn
            return num.toLocaleString('en-US');
        }
        async function fetchCryptoData() {
                try {
                    const response = await fetch('/api/crypto/global');
                    if (!response.ok) throw new Error('Lỗi khi lấy dữ liệu global.');

                    const data = await response.json();
                    // print ra gia tri data
                    console.log(data);
                    
                    // Truy cập trực tiếp vào các key của JSON mới
                    document.getElementById('market-cap').textContent = '$' + formatNumber(data['market-cap']);
                    document.getElementById('volume-24h').textContent = '$' + formatNumber(data['volume-24h']);

                } catch (error) {
                    console.error('Lỗi fetchCryptoData:', error);
                    ['market-cap', 'volume-24h'].forEach(id => document.getElementById(id).textContent = error);
                    console.log(error);
                }
            }


        async function fetchBtcAndFearGreed() {
            try {
                // Gọi đến endpoint kết hợp để lấy giá BTC và chỉ số F&G
                const response = await fetch('/api/crypto/btc-and-fng');
                if (!response.ok) throw new Error('Lỗi khi lấy dữ liệu BTC và F&G.');

                const data = await response.json();

                // Xử lý dữ liệu BTC
                const bitcoin = data.bitcoin.bitcoin;
                document.getElementById('btc-price').textContent = '$' + bitcoin.usd.toLocaleString('en-US');
                const btcChangeEl = document.getElementById('btc-change');
                const change = bitcoin.usd_24h_change;
                btcChangeEl.textContent = `${change.toFixed(2)}% (24h)`;
                btcChangeEl.className = `text-sm font-semibold ${change >= 0 ? 'text-green-600' : 'text-red-600'}`;

                // Xử lý dữ liệu Fear & Greed
                const fearGreed = data.fear_and_greed.data[0];
                const valueEl = document.getElementById('fear-greed-value');
                const textEl = document.getElementById('fear-greed-text');
                valueEl.textContent = fearGreed.value;
                textEl.textContent = fearGreed.value_classification;
                let colorClass = 'text-yellow-500';
                if (parseInt(fearGreed.value) <= 25) colorClass = 'text-red-600';
                if (parseInt(fearGreed.value) >= 75) colorClass = 'text-green-600';
                textEl.className = `text-sm font-medium ${colorClass}`;

            } catch (error) {
                console.error('Lỗi fetchBtcAndFearGreed:', error);
                ['btc-price', 'fear-greed-value'].forEach(id => document.getElementById(id).textContent = 'Error');
            }
        }


        // Script mới để tải nội dung báo cáo (giữ nguyên)
        async function loadReport() {
            try {
                const response = await fetch("{{ url_for('static', filename='report.html') }}");
                if (!response.ok) throw new Error('Không thể tải tệp báo cáo.');
                const reportHtml = await response.text();
                document.getElementById('report-container').innerHTML = reportHtml;
            } catch (error) {
                console.error('Lỗi tải báo cáo:', error);
                document.getElementById('report-container').innerHTML = '<p>Không thể tải nội dung báo cáo.</p>';
            }
        }

        function init() {
            loadReport();
            fetchCryptoData();
            fetchBtcAndFearGreed();
            setInterval(fetchCryptoData, 300000); // Giảm tần suất gọi
            setInterval(fetchBtcAndFearGreed, 300000);
        }

        window.onload = init;
    </script>
   
</body>
</html>
