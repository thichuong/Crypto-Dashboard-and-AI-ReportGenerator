# 🚀 Railway Deployment Guide - Crypto Dashboard

## 📋 Tóm tắt vấn đề và giải pháp

### ❌ Vấn đề gốc
```
Migration failed: (psycopg2.OperationalError) could not translate host name "postgres.railway.internal" to address: Name or service not known
```

### ✅ Nguyên nhân và giải pháp
1. **Lỗi DNS Resolution**: Hostname `postgres.railway.internal` chỉ có thể truy cập từ bên trong Railway network
2. **Environment Variables thiếu**: `DATABASE_URL` không được set đúng cách
3. **Migration script không handle errors**: Script cũ không có fallback cho local development

## 🔧 Giải pháp đã thực hiện

### 1. **Improved Migration Script** (`migrate_railway_v2.py`)
- ✅ Kiểm tra environment trước khi connect
- ✅ Fallback cho local development (SQLite)
- ✅ Better error handling và troubleshooting tips
- ✅ Safe logging (không expose credentials)

### 2. **Updated Configuration** (`app/config.py`)
- ✅ Support cả `DATABASE_URL` và `POSTGRES_URL`
- ✅ Improved SSL settings cho Railway
- ✅ Increased timeout cho Railway connections
- ✅ Debug info an toàn

### 3. **Railway Configuration** (`railway.json`)
- ✅ Updated start command để dùng script v2
- ✅ Increased health check timeout
- ✅ Added `FLASK_ENV=production`

### 4. **Health Check Tool** (`railway_health_check.py`)
- ✅ Debug database connections
- ✅ Check environment variables
- ✅ Safe credential display
- ✅ Detailed troubleshooting suggestions

## 🚀 Deployment Steps

### Bước 1: Chuẩn bị môi trường Railway

1. **Login vào Railway**:
```bash
railway login
```

2. **Link project** (nếu chưa có):
```bash
railway link
```

3. **Add PostgreSQL service** trong Railway dashboard:
   - Vào Railway dashboard
   - Click "Add Service" → "Database" → "PostgreSQL"
   - Railway sẽ tự động tạo `DATABASE_URL`

### Bước 2: Set Environment Variables

Trong Railway dashboard, đảm bảo có các biến sau:

```bash
# Required
DATABASE_URL=postgresql://...  # Auto-generated by Railway PostgreSQL service
GEMINI_API_KEY=your_gemini_api_key

# Optional but recommended
FLASK_ENV=production
REDIS_URL=redis://...  # If using Redis
SECRET_KEY=your_secret_key
ENABLE_AUTO_REPORT_SCHEDULER=true
AUTO_REPORT_INTERVAL_HOURS=3
```

### Bước 3: Deploy

1. **Commit changes**:
```bash
git add .
git commit -m "Fix Railway deployment with improved migration script"
git push
```

2. **Deploy to Railway**:
```bash
railway up
```

Hoặc configure auto-deploy từ GitHub trong Railway dashboard.

### Bước 4: Verify Deployment

1. **Check deployment logs**:
```bash
railway logs --follow
```

2. **Test health endpoint**:
```bash
curl https://your-app.railway.app/health
```

## 🔍 Troubleshooting

### Nếu vẫn gặp lỗi migration:

1. **Check environment variables**:
```bash
railway variables
```

2. **Run migration manually trong Railway**:
```bash
railway run python migrate_railway_v2.py
```

3. **Check database connection**:
```bash
railway run python railway_health_check.py
```

### Common Issues:

#### ❌ `DATABASE_URL not set`
```bash
# Solution: Add PostgreSQL service in Railway dashboard
railway add postgresql
```

#### ❌ `SSL connection error`
```bash
# Solution: Check if SSL settings are correct in config.py
# Railway PostgreSQL requires SSL
```

#### ❌ `Timeout errors`
```bash
# Solution: Increased timeouts in railway.json
# Check network connectivity
```

#### ❌ `Permission denied errors`
```bash
# Solution: Check if Railway service has proper permissions
# Restart the service
```

## 📁 Files được cập nhật

### New Files:
- `migrate_railway_v2.py` - Improved migration script
- `railway_health_check.py` - Database health checker
- `railway_start_v2.sh` - Improved deployment script
- `RAILWAY_DEPLOYMENT_GUIDE.md` - Documentation này

### Updated Files:
- `app/config.py` - Better database configuration
- `railway.json` - Updated deployment settings

## ✅ Verification Checklist

- [ ] PostgreSQL service added in Railway dashboard
- [ ] `DATABASE_URL` environment variable set
- [ ] Required API keys configured (`GEMINI_API_KEY`)
- [ ] Health check endpoint responds (`/health`)
- [ ] Migration runs successfully
- [ ] Application starts without errors
- [ ] Database tables created correctly

## 🆘 Support

Nếu vẫn gặp vấn đề:

1. **Run health check locally**:
```bash
python railway_health_check.py
```

2. **Check Railway logs**:
```bash
railway logs --tail 100
```

3. **Test migration locally**:
```bash
python migrate_railway_v2.py
```

4. **Verify database connection**:
```bash
railway connect postgresql
\dt  # List tables
\q   # Quit
```

## 🎯 Next Steps

1. Monitor deployment trong Railway dashboard
2. Set up monitoring/alerting nếu cần
3. Configure auto-scaling nếu có traffic cao
4. Backup database regularly

---

**Note**: Luôn test changes trong local environment trước khi deploy lên production!
